<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://unpkg.com/jquery-tablesort@0.0.11/jquery.tablesort.min.js"></script>
  <link rel="stylesheet" href="btracer.css">
</head>
<body>

<div class="ui container">
  <h2 class="ui no-mar-bot page header">
    <i class="binoculars icon"></i>
    <div class="content">BCTracer
      <div class="sub header">Class Tracer featured by BPF</div>
    </div>
  </h2>

  <div class="ui no-mar no-pad-top right floated filter basic segment" id="filterHolder"></div>
  <table class="ui sortable very compact table" id="graph">
    <thead>
    <tr>
      <th class="center aligned three wide">Timestamp</th>
      <th class="center aligned one wide">cpu</th>
      <th class="center aligned no-sort two wide">_delta</th>
      <th class="no-sort ten wide">Function</th>
    </tr>
    </thead>
    <tbody id="graphHolder"></tbody>
  </table>



</div>
</body>
<script>
  // F-<tag> stands for filter, TPL stands for template
  let debug = true;
  // let debug = false;
  let timestamps = [];

  function renderCallgraph(trace) {
    // Delimits '|' and '\d)'
    const del = new RegExp('(?<=\\d)\\)|\\|', "g");
    const _trim = x => typeof x === 'string' ? x.trim() : '';

    let callGraph = trace.split('\n');
    let graph = '', filter = '<span> Filter CPU: </span>';
    let cpus = new Set();

    callGraph.forEach((line) => {
      let row = line.split(del);
      let [ts, cpu = 'X', delta] = _.initial(row).map(_trim);
      // String literal $ not working due to conflict with jquery
      graph += callTPL(ts, cpu, delta, _.last(row));
      timestamps.push(ts);
      cpus.add(cpu);
    });


    $('#graphHolder').html(graph);
    Array.from(cpus).sort().forEach(cpu => filter += filterTPL(cpu));
    $('#filterHolder').html(filter);


    // TODO: Move logic after rendered
    $('.ui.checkbox').checkbox({
      onChange: function () {
        let cpu = this.getAttribute('data-cpu');
        $(`[f-cpu='${cpu}']`).toggle()
      }
    });


  }

  $(document).ready(function () {
    if(debug) {
      renderCallgraph(sample);
    }

    $('#graph').tablesort();
    console.log("Data sort Done");


    let data = _.keys(sampleData);
    data.forEach((val, idx) => {
      let prev = (idx === 0) ? null :  sampleData[data[idx-1]];
      let curr = sampleData[data[idx]];

      $(`[f-ts='${val}']`).addClass('negative');
      $(`[f-ts='${val}']`).popup({
          position: 'top center',
          html: diffData(prev,curr)
        });
      debugger
    });

  });
</script>
<script src="template.js"></script>
</html>

