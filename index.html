<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://unpkg.com/jquery-tablesort@0.0.11/jquery.tablesort.min.js"></script>
  <link rel="stylesheet" href="btracer.css">
</head>
<body>

<div class="ui container">
  <h2 class="ui no-mar-bot page header">
    <i class="binoculars icon"></i>
    <div class="content">BCTracer
      <div class="sub header">Class Tracer featured by BPF</div>
    </div>
  </h2>

  <div class="ui no-mar no-pad right floated class filter basic segment">
    <div class="ui checkbox">
      <input type="checkbox" data-type='class'>
      <label>Class Only</label>
    </div>
  </div>
  <div class="ui no-mar no-pad right floated cpu filter basic segment"></div>

  <table class="ui sortable very compact table" id="graph">
    <thead>
    <tr>
      <th class="center aligned three wide">Timestamp</th>
      <th class="center aligned one wide">cpu</th>
      <th class="center aligned no-sort two wide">_delta</th>
      <th class="no-sort ten wide">Function</th>
    </tr>
    </thead>
    <tbody id="graphBox"></tbody>
  </table>


</div>
</body>
<script>
  // F-<tag> stands for filter, TPL stands for template
  let debug = true;
  let traceData = {};

  function renderCallgraph(trace) {
    // Delimits '|' and '\d)'
    const del = new RegExp('(?<=\\d)\\)|\\|', "g");
    const _trim = x => typeof x === 'string' ? x.trim() : '';

    let callGraph = trace.split('\n');
    let graph = '', filter = '<span> Filter CPU: </span>';
    let cpus = new Set();

    callGraph.forEach((line) => {
      let row = line.split(del);
      let name = _.last(row);
      let [ts, cpu = 'X', delta] = _.initial(row).map(_trim);

      if (name.includes('=>')) {
        ts = undefined;
      }
      if (!_.isEmpty(ts) && !name.includes('}')) {
        traceData[ts] = name.trim();
      }
      graph += callTPL(ts, cpu, delta, name);
      cpus.add(cpu);
    });


    $('#graphBox').html(graph);
    Array.from(cpus).sort().forEach(cpu => filter += filterTPL(cpu));
    $('.cpu.filter').html(filter);


    // TODO: Move logic after rendered
    $('.ui.checkbox').checkbox({
      onChange: function () {
        let type = this.getAttribute('data-type'), sel='';

        if (type === 'cpu')
          sel = `[f-cpu='${this.getAttribute('cpu')}']`;
        else if (type === 'class')
          sel = `#graphBox tr:not(.negative)`;

        if(this.checked) $(sel).show();
        else             $(sel).hide();
      }
    });
  }

  $(document).ready(function () {
    if (debug) {
      renderCallgraph(sample);
    }

    $('#graph').tablesort();
    console.log("Data sort Done");

    sampleData.forEach((val, idx) => {
      let prev = (idx === 0) ? null : sampleData[idx - 1]['values'];
      let curr = sampleData[idx]['values'];
      let curr_name = sampleData[idx]['function_name'];
      let curr_ts = sampleData[idx]['timestamp'];
      let next_ts = (idx + 1 === sampleData.length) ? 99999999999999 : sampleData[idx + 1]['timestamp'];

      let avail_ts = _.keys(traceData).filter(t => _.inRange(t, curr_ts, next_ts));
      let final_ts = avail_ts.filter(t => traceData[t].startsWith(curr_name));

      if (!_.isEmpty(final_ts)) {
        $(`[f-ts='${final_ts[0]}']`)
          .addClass('negative')
          .popup({
            position: 'top center',
            html: diffData(prev, curr)
          });
      }
    });
  });
</script>
<script src="template.js"></script>
<script src="trace.js"></script>
<script src="data.js"></script>
</html>

